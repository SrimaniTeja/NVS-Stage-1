package com.example.nvs.core;

import com.example.nvs.model.CVEEntry;
import com.google.gson.*;
import okhttp3.*;

import java.io.IOException;
import java.util.*;

public class VulnerabilityScanner {

    private static final OkHttpClient client = new OkHttpClient();
    private static final String API_URL = "https://cve.circl.lu/api/search/";

    public static List<CVEEntry> lookupByProduct(String vendor, String product) {
        List<CVEEntry> result = new ArrayList<>();
        String url = API_URL + vendor + "/" + product;

        Request request = new Request.Builder().url(url).build();
        try (Response response = client.newCall(request).execute()) {
            if (!response.isSuccessful() || response.body() == null) return result;

            JsonArray arr = JsonParser.parseString(response.body().string()).getAsJsonArray();
            for (JsonElement je : arr) {
                JsonObject jo = je.getAsJsonObject();
                result.add(new CVEEntry(
                        jo.get("id").getAsString(),
                        jo.get("summary").getAsString(),
                        jo.has("cvss") && !jo.get("cvss").isJsonNull() ? jo.get("cvss").getAsDouble() : 0.0,
                        jo.get("Published").getAsString()
                ));
            }
        } catch (IOException e) {
            e.printStackTrace();
        }

        return result;
    }
}
